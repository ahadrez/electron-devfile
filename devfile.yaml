# Devfile for OpenShift Dev Spaces to develop an Electron app
# Uses your custom UBI Node.js base with Electron system deps.

schemaVersion: 2.2.0
metadata:
  name: electron-devspace
attributes:
  # Keep container alive even if no command is running
  controller.devfile.io/storage-type: per-workspace

projects:
  - name: electron-app
    # This clones your Electron app into the workspace
    git:
      remotes:
        origin: https://github.com/ahadrez/electron-app.git
    # Place it under /projects/electron-app
    clonePath: electron-app

components:
  - name: tools
    container:
      image: <REGISTRY>/<NAMESPACE>/electron-devspace:latest
      memoryLimit: 2Gi
      cpuLimit: 1500m
      mountSources: true
      sourceMapping: /projects
      env:
        - name: DISPLAY
          value: ":99"
        - name: ELECTRON_DISABLE_SANDBOX
          value: "1"
        - name: NO_AT_BRIDGE
          value: "1"
      # Keep container running
      command: ["bash", "-lc"]
      args: ["sleep infinity"]

commands:
  - id: prestart-xvfb
    exec:
      component: tools
      label: Start Xvfb if present
      commandLine: |
        bash -lc '[ -x /usr/bin/Xvfb ] && (nohup /usr/bin/Xvfb :99 -screen 0 1280x800x24 >/tmp/xvfb.log 2>&1 & sleep 1) || echo "Xvfb not installed; running headless"'
      workingDir: /projects
      group:
        kind: run
        isDefault: false

  - id: npm-install
    exec:
      component: tools
      label: npm install
      commandLine: bash -lc 'npm ci || npm install'
      workingDir: ${PROJECTS_ROOT}/electron-app
      group:
        kind: build
        isDefault: true

  - id: npm-start
    exec:
      component: tools
      label: Start Electron (xvfb if available)
      commandLine: |
        bash -lc 'if command -v xvfb-run >/dev/null 2>&1; then xvfb-run -a npm start; else npm start; fi'
      workingDir: ${PROJECTS_ROOT}/electron-app
      group:
        kind: run
        isDefault: true

  - id: npm-test
    exec:
      component: tools
      label: Test (headless/xvfb)
      commandLine: |
        bash -lc 'if command -v xvfb-run >/dev/null 2>&1; then xvfb-run -a npm test; else npm test; fi'
      workingDir: ${PROJECTS_ROOT}/electron-app
      group:
        kind: test
        isDefault: true

events:
  preStart:
    - prestart-xvfb
