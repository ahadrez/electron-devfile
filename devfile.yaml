schemaVersion: 2.2.2
metadata:
  name: nodejs-electron-xvfb
components:
  - name: runtime
    container:
      image: quay.io/upstream/devspaces:electron
      args: ['tail','-f','/dev/null']
      memoryLimit: 2048Mi
      mountSources: true
      env:
        - name: DEBUG_PORT
          value: '5858'
        - name: ELECTRON_DISABLE_SANDBOX
          value: '1'
        - name: NO_AT_BRIDGE
          value: '1'
        - name: DISPLAY
          value: ':99'    # Xvfb display
      endpoints:
        - name: https-node
          targetPort: 3000
          protocol: https
        - exposure: none
          name: debug
          targetPort: 5858

commands:
  - id: npm-install
    exec:
      component: runtime
      commandLine: npm install
      workingDir: ${PROJECT_SOURCE}
      group: { kind: build, isDefault: true }

  - id: boot-gui
    exec:
      component: runtime
      commandLine: |
        dbus-daemon --session --fork --address=unix:path=/tmp/dbus.sock
        echo -n "unix:path=/tmp/dbus.sock" > /tmp/dbus.addr
        Xvfb :99 -screen 0 1920x1080x24 -ac +extension RANDR &
      workingDir: ${PROJECT_SOURCE}

  - id: run-app
    exec:
      component: runtime
      commandLine: |
        export DBUS_SESSION_BUS_ADDRESS=$(cat /tmp/dbus.addr 2>/dev/null || echo)
        npm start
      workingDir: ${PROJECT_SOURCE}

  - id: run
    composite:
      label: Run Electron (Xvfb)
      commands: [boot-gui, run-app]
      group: { kind: run, isDefault: true }

  - id: debug
    exec:
      component: runtime
      commandLine: npm run debug
      workingDir: ${PROJECT_SOURCE}
      group: { kind: debug, isDefault: true }

  - id: test
    exec:
      component: runtime
      commandLine: npm test
      workingDir: ${PROJECT_SOURCE}
      group: { kind: test, isDefault: true }
